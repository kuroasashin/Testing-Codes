<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Management System</title>
    
    <!-- INLINE CSS - Ensures modal displays correctly -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .google-btn {
            width: 100%;
            padding: 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .google-btn:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }

        .input-field {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        /* CRITICAL: MODAL STYLES - This is what was missing! */
        .modal {
            display: block !important; /* Must be block to show */
            position: fixed !important;
            z-index: 9999 !important; /* Very high z-index to be on top */
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
            overflow: auto !important;
            background-color: rgba(0,0,0,0.7) !important; /* Semi-transparent black background */
            backdrop-filter: blur(5px) !important; /* Optional: blur effect */
        }

        .modal-content {
            background-color: #fefefe !important;
            margin: 10% auto !important; /* Center vertically and horizontally */
            padding: 30px !important;
            border: 1px solid #888 !important;
            width: 90% !important;
            max-width: 500px !important;
            border-radius: 15px !important;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3) !important;
            position: relative !important;
            animation: modalOpen 0.3s ease-out !important;
        }

        @keyframes modalOpen {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            color: #aaa !important;
            float: right !important;
            font-size: 28px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            position: absolute !important;
            right: 20px !important;
            top: 15px !important;
            z-index: 10000 !important;
        }

        .close:hover,
        .close:focus {
            color: #333 !important;
        }

        /* Main App */
        #appContainer {
            background: white;
            min-height: 100vh;
            display: none;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            background: transparent;
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-logout {
            background: white;
            color: #667eea;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .tab-content {
            padding: 30px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Attendance Buttons */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .attendance-btn {
            padding: 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .attendance-btn.present {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .attendance-btn.sick {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .attendance-btn.late {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .attendance-btn.leave {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .attendance-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        /* Admin Dashboard */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
        }

        .stat-card p {
            font-size: 32px;
            font-weight: bold;
            margin-top: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                margin: 5px;
                padding: 8px 15px;
                font-size: 12px;
            }
            
            .modal-content {
                margin: 20% auto !important;
                padding: 20px !important;
            }
        }

        @media (max-width: 480px) {
            .login-box {
                padding: 20px;
            }
        }
    </style>
    
    <!-- LOAD FIREBASE SDK FIRST -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        // ============================================
        // FIREBASE CONFIGURATION - REPLACE WITH YOURS
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyC...", // ‚ö†Ô∏è REPLACE WITH YOUR API KEY
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("‚úì Firebase SDK initialized successfully");
        } catch (error) {
            console.error("‚úó Firebase initialization error:", error);
        }

        // Initialize services
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Admin credentials
        const ADMIN_EMAIL = "admin@example.com"; // ‚ö†Ô∏è CHANGE THIS
        const ADMIN_OTP = "123456"; // ‚ö†Ô∏è CHANGE THIS

        // Global state
        let currentUser = null;
        let isAdmin = false;
    </script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2>Attendance Management System</h2>
            
            <!-- User Login Section -->
            <div id="userLogin">
                <button id="googleLoginBtn" class="google-btn">
                    <img src="https://img.icons8.com/color/24/000000/google-logo.png"/>
                    Sign in with Google
                </button>
                <p id="loginStatus" style="margin-top: 10px; color: #666; font-size: 12px;"></p>
            </div>
            
            <!-- Admin Login Section (Hidden by default) -->
            <div id="adminLogin" style="display:none;">
                <h3>üîê Admin Login</h3>
                <input type="email" id="adminEmail" placeholder="Admin Email" class="input-field">
                <input type="password" id="adminOTP" placeholder="One-Time Password" class="input-field">
                <button id="adminLoginBtn" class="btn">Login</button>
                <button id="backToUserLogin" class="btn-outline">‚Üê Back to User Login</button>
            </div>
            
            <div style="margin-top: 20px;">
                <button id="switchToAdmin" class="btn-outline">üîê Admin Login</button>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden initially) -->
    <div id="appContainer" style="display:none;">
        <!-- Navigation Tabs -->
        <nav class="navbar">
            <div class="logo">Attendance System</div>
            <div class="nav-tabs">
                <button class="tab-btn active" data-tab="attendance">Attendance</button>
                <button class="tab-btn" data-tab="mc">MC Submission</button>
                <button class="tab-btn" data-tab="parade">Parade State</button>
                <button class="tab-btn" data-tab="missing">Missing Attendance</button>
                <button id="adminDashboardBtn" class="tab-btn" style="display:none;">Admin Dashboard</button>
            </div>
            <div class="user-info">
                <span id="userName"></span>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </nav>

        <!-- Tab Contents -->
        <div class="tab-content">
            <!-- Attendance Tab -->
            <div id="attendance" class="tab-pane active">
                <h2>Attendance</h2>
                <div class="button-grid">
                    <button id="presentBtn" class="attendance-btn present">Present</button>
                    <button id="rsoBtn" class="attendance-btn sick">Report Sick Outside (RSO)</button>
                    <button id="rsiBtn" class="attendance-btn sick">Report Sick Inside (RSI)</button>
                    <button id="lateBtn" class="attendance-btn late">Late</button>
                    <button id="leaveBtn" class="attendance-btn leave">Leave</button>
                </div>

                <!-- Modal Forms -->
                <div id="rsoModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h3>Report Sick Outside (RSO)</h3>
                        <input type="text" id="rsoSymptom" placeholder="Symptom" class="input-field">
                        <input type="text" id="rsoLocation" placeholder="Location" class="input-field">
                        <button id="submitRsoBtn" class="btn">Submit</button>
                    </div>
                </div>

                <div id="rsiModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h3>Report Sick Inside (RSI)</h3>
                        <input type="text" id="rsiSymptom" placeholder="Symptom" class="input-field">
                        <button id="submitRsiBtn" class="btn">Submit</button>
                    </div>
                </div>

                <div id="lateModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h3>Late Report</h3>
                        <input type="text" id="lateReason" placeholder="Reason" class="input-field">
                        <input type="time" id="lateTime" placeholder="EST Time" class="input-field">
                        <button id="submitLateBtn" class="btn">Submit</button>
                    </div>
                </div>

                <div id="leaveModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h3>Leave Application</h3>
                        <select id="leaveType" class="input-field">
                            <option value="FullDay">Full Day</option>
                            <option value="HalfDayAM">Half Day (AM)</option>
                            <option value="HalfDayPM">Half Day (PM)</option>
                        </select>
                        <button id="submitLeaveBtn" class="btn">Submit</button>
                    </div>
                </div>
            </div>

            <!-- MC Submission Tab -->
            <div id="mc" class="tab-pane">
                <h2>MC Submission</h2>
                <p>MC submission functionality coming soon...</p>
            </div>

            <!-- Parade State Tab -->
            <div id="parade" class="tab-pane">
                <h2>Parade State</h2>
                <p>Parade state functionality coming soon...</p>
            </div>

            <!-- Missing Attendance Tab -->
            <div id="missing" class="tab-pane">
                <h2>Missing Attendance</h2>
                <p>Missing attendance functionality coming soon...</p>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="tab-pane">
                <h2>Admin Dashboard</h2>
                <div class="admin-stats">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <p id="totalUsers">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Today's Attendance</h3>
                        <p id="todaysAttendance">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Pending MCs</h3>
                        <p id="pendingMcs">0</p>
                    </div>
                </div>
                <div id="adminTableContainer"></div>
            </div>
        </div>
    </div>

    <!-- ALL SCRIPTS AT THE END -->
    <script>
        console.log("‚úì Starting app initialization...");

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const userName = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const loginStatus = document.getElementById('loginStatus');
        const switchToAdmin = document.getElementById('switchToAdmin');
        const adminLogin = document.getElementById('adminLogin');
        const backToUserLogin = document.getElementById('backToUserLogin');
        const adminEmail = document.getElementById('adminEmail');
        const adminOTP = document.getElementById('adminOTP');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminDashboardBtn = document.getElementById('adminDashboardBtn');

        // ============================================
        // FIREBASE AUTH STATE LISTENER
        // ============================================
        auth.onAuthStateChanged(async (user) => {
            console.log("\n=== AUTH STATE CHANGED ===");
            console.log("User:", user ? user.email : "null");
            
            if (user) {
                console.log("‚úì User is authenticated");
                currentUser = user;
                await handleUserLogin(user);
            } else {
                console.log("‚úó No user authenticated");
                showLoginScreen();
            }
            console.log("=========================\n");
        });

        // ============================================
        // HANDLE USER LOGIN
        // ============================================
        async function handleUserLogin(user) {
            console.log("‚Üí handleUserLogin called for:", user.email);
            
            try {
                // Check if user exists in database
                console.log("  ‚Üí Checking if user exists in database...");
                const userDoc = await db.collection('users').doc(user.uid).get();
                console.log("  ‚Üí User doc exists:", userDoc.exists);
                
                if (!userDoc.exists) {
                    console.log("  ‚Üí User not found, showing registration form");
                    showRegistrationForm(user);
                } else {
                    console.log("  ‚Üí User found, loading app");
                    const userData = userDoc.data();
                    console.log("  ‚Üí User ", userData);
                    
                    isAdmin = userData.isAdmin || user.email === ADMIN_EMAIL;
                    console.log("  ‚Üí isAdmin:", isAdmin);
                    
                    loadApp(user, userData);
                }
            } catch (error) {
                console.error("‚úó Error in handleUserLogin:", error);
                console.error("Error details:", error.message);
                
                // Show error in UI
                loginStatus.textContent = "Error: " + error.message;
                loginStatus.style.color = "red";
                
                // Don't auto sign out - let user try again
                setTimeout(() => {
                    loginStatus.textContent = "";
                }, 5000);
            }
        }

        // ============================================
        // GOOGLE SIGN-IN
        // ============================================
        googleLoginBtn.addEventListener('click', async () => {
            console.log("‚Üí Google sign-in button clicked");
            
            try {
                loginStatus.textContent = "Signing in...";
                loginStatus.style.color = "#667eea";
                
                googleLoginBtn.disabled = true;
                googleLoginBtn.innerHTML = '<img src="https://img.icons8.com/color/24/000000/google-logo.png"/> Signing in...';
                
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                
                console.log("‚úì Google sign-in successful:", result.user.email);
                console.log("  ‚Üí User UID:", result.user.uid);
                
                loginStatus.textContent = "Sign-in successful! Loading...";
                
            } catch (error) {
                console.error("‚úó Google sign-in error:", error);
                
                loginStatus.textContent = "Error: " + error.message;
                loginStatus.style.color = "red";
                
                googleLoginBtn.disabled = false;
                googleLoginBtn.innerHTML = '<img src="https://img.icons8.com/color/24/000000/google-logo.png"/> Sign in with Google';
                
                setTimeout(() => {
                    loginStatus.textContent = "";
                }, 5000);
            }
        });

        // ============================================
        // ADMIN LOGIN
        // ============================================
        adminLoginBtn.addEventListener('click', async () => {
            const email = adminEmail.value.trim();
            const otp = adminOTP.value.trim();
            
            console.log("‚Üí Admin login attempt:", email);
            
            if (!email || !otp) {
                alert("Please fill in all fields");
                return;
            }
            
            if (email === ADMIN_EMAIL && otp === ADMIN_OTP) {
                try {
                    adminLoginBtn.disabled = true;
                    adminLoginBtn.textContent = "Logging in...";
                    
                    const adminUser = {
                        email: email,
                        name: "Administrator",
                        isAdmin: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const anonUser = await auth.signInAnonymously();
                    await db.collection('users').doc(anonUser.user.uid).set(adminUser);
                    isAdmin = true;
                    
                    console.log("‚úì Admin login successful");
                    loadApp(anonUser.user, adminUser);
                    
                } catch (error) {
                    console.error("‚úó Admin login error:", error);
                    alert("Login failed: " + error.message);
                    adminLoginBtn.disabled = false;
                    adminLoginBtn.textContent = "Login";
                }
            } else {
                alert("Invalid admin credentials");
            }
        });

        // ============================================
        // REGISTRATION FORM - FIXED VERSION
        // ============================================
        function showRegistrationForm(user) {
            console.log("‚Üí showRegistrationForm called");
            
            // Remove any existing modals first
            const existingModal = document.getElementById('registrationModal');
            if (existingModal) {
                document.body.removeChild(existingModal);
            }
            
            // Create modal with inline styles for maximum compatibility
            const modal = document.createElement('div');
            modal.id = 'registrationModal';
            modal.style.cssText = `
                display: block !important;
                position: fixed !important;
                z-index: 9999 !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: 100% !important;
                overflow: auto !important;
                background-color: rgba(0,0,0,0.7) !important;
                backdrop-filter: blur(5px) !important;
            `;
            
            modal.innerHTML = `
                <div style="
                    background-color: #fefefe !important;
                    margin: 10% auto !important;
                    padding: 30px !important;
                    border: 1px solid #888 !important;
                    width: 90% !important;
                    max-width: 500px !important;
                    border-radius: 15px !important;
                    box-shadow: 0 10px 50px rgba(0,0,0,0.3) !important;
                    position: relative !important;
                    animation: modalOpen 0.3s ease-out !important;
                ">
                    <span style="
                        color: #aaa !important;
                        float: right !important;
                        font-size: 28px !important;
                        font-weight: bold !important;
                        cursor: pointer !important;
                        position: absolute !important;
                        right: 20px !important;
                        top: 15px !important;
                        z-index: 10000 !important;
                    " class="close">&times;</span>
                    <h3 style="margin-top: 0;">üìù Welcome! Please Register</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        <strong>Email:</strong> ${user.email}
                    </p>
                    <input 
                        type="text" 
                        id="userNameInput" 
                        placeholder="Enter your full name" 
                        style="
                            width: 100%;
                            padding: 12px;
                            margin: 10px 0;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            font-size: 14px;
                        "
                        autofocus
                    >
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button 
                            id="registerBtn" 
                            style="
                                flex: 1;
                                padding: 12px;
                                background: #667eea;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 16px;
                            "
                        >Register & Continue</button>
                        <button 
                            id="cancelBtn" 
                            style="
                                flex: 1;
                                padding: 12px;
                                background: transparent;
                                border: 2px solid #667eea;
                                color: #667eea;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 16px;
                            "
                        >Cancel</button>
                    </div>
                    <p id="registerStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></p>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log("‚úì Registration modal created and appended");
            console.log("‚úì Modal element:", modal);
            console.log("‚úì Modal computed style:", window.getComputedStyle(modal).display);
            
            const registerStatus = modal.querySelector('#registerStatus');
            
            // Close button - DON'T sign out, just close modal
            const closeBtn = modal.querySelector('.close');
            closeBtn.onclick = () => {
                console.log("‚Üí Registration modal closed (close button)");
                document.body.removeChild(modal);
                // Don't sign out - user might want to try again
                showLoginScreen();
            };
            
            // Cancel button - DON'T sign out
            const cancelBtn = modal.querySelector('#cancelBtn');
            cancelBtn.onclick = () => {
                console.log("‚Üí Registration cancelled");
                document.body.removeChild(modal);
                showLoginScreen();
            };
            
            // Register button
            const registerBtn = modal.querySelector('#registerBtn');
            registerBtn.onclick = async () => {
                const name = document.getElementById('userNameInput').value.trim();
                
                if (!name) {
                    registerStatus.textContent = "Please enter your name";
                    registerStatus.style.color = "red";
                    return;
                }
                
                try {
                    console.log("‚Üí Registering user:", name);
                    registerStatus.textContent = "Registering...";
                    registerStatus.style.color = "#667eea";
                    registerBtn.disabled = true;
                    
                    await db.collection('users').doc(user.uid).set({
                        name: name,
                        email: user.email,
                        isAdmin: user.email === ADMIN_EMAIL,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log("‚úì User registered successfully");
                    registerStatus.textContent = "Registration successful! Loading app...";
                    registerStatus.style.color = "green";
                    
                    // Small delay to show success message
                    setTimeout(() => {
                        document.body.removeChild(modal);
                        console.log("‚Üí Loading app for registered user");
                        
                        loadApp(user, { 
                            name, 
                            email: user.email, 
                            isAdmin: user.email === ADMIN_EMAIL 
                        });
                    }, 1000);
                    
                } catch (error) {
                    console.error("‚úó Registration error:", error);
                    registerStatus.textContent = "Error: " + error.message;
                    registerStatus.style.color = "red";
                    registerBtn.disabled = false;
                    
                    alert("Registration failed: " + error.message + "\n\nPlease check:\n1. Disable ad blockers\n2. Check internet connection\n3. Try again");
                }
            };
            
            // Enter key support
            document.getElementById('userNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    registerBtn.click();
                }
            });
        }

        // ============================================
        // LOAD APP
        // ============================================
        function loadApp(user, userData) {
            console.log("‚Üí loadApp called");
            console.log("  ‚Üí User:", user.email);
            console.log("  ‚Üí User ", userData);
            console.log("  ‚Üí isAdmin:", isAdmin);
            
            try {
                // Set user display name
                userName.textContent = userData.name || user.email;
                console.log("‚úì User name set to:", userName.textContent);
                
                // Show admin dashboard button if admin
                if (userData.isAdmin || user.email === ADMIN_EMAIL) {
                    adminDashboardBtn.style.display = 'block';
                    isAdmin = true;
                    console.log("‚úì Admin dashboard button shown");
                }
                
                // Hide login screen, show app
                console.log("  ‚Üí Hiding login screen...");
                loginScreen.style.display = 'none';
                
                console.log("  ‚Üí Showing app container...");
                appContainer.style.display = 'block';
                
                console.log("‚úì App loaded successfully!");
                
                // Initialize attendance module
                console.log("‚Üí Initializing attendance module...");
                initializeAttendance();
                
            } catch (error) {
                console.error("‚úó Error in loadApp:", error);
                console.error("Error stack:", error.stack);
                alert("Error loading app: " + error.message);
            }
        }

        // ============================================
        // SHOW LOGIN SCREEN
        // ============================================
        function showLoginScreen() {
            console.log("‚Üí showLoginScreen called");
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
            currentUser = null;
            isAdmin = false;
        }

        // ============================================
        // LOGOUT
        // ============================================
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                console.log("‚úì User signed out");
            } catch (error) {
                console.error("Logout error:", error);
                alert("Logout failed: " + error.message);
            }
        });

        // ============================================
        // SWITCH TO ADMIN LOGIN
        // ============================================
        switchToAdmin.addEventListener('click', () => {
            adminLogin.style.display = 'block';
            document.getElementById('userLogin').style.display = 'none';
            switchToAdmin.style.display = 'none';
        });

        backToUserLogin.addEventListener('click', () => {
            adminLogin.style.display = 'none';
            document.getElementById('userLogin').style.display = 'block';
            switchToAdmin.style.display = 'block';
        });

        // ============================================
        // TAB SWITCHING
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                    
                    if (btn.dataset.tab === 'adminDashboard') {
                        loadAdminDashboard();
                    }
                });
            });
        });

        // ============================================
        // ATTENDANCE MODULE
        // ============================================
        function initializeAttendance() {
            console.log("‚Üí initializeAttendance called");
            
            const OFFICE_LAT = 1.3500;
            const OFFICE_LNG = 103.8991;
            const RADIUS = 250;

            const presentBtn = document.getElementById('presentBtn');
            const rsoBtn = document.getElementById('rsoBtn');
            const rsiBtn = document.getElementById('rsiBtn');
            const lateBtn = document.getElementById('lateBtn');
            const leaveBtn = document.getElementById('leaveBtn');

            const rsoModal = document.getElementById('rsoModal');
            const rsiModal = document.getElementById('rsiModal');
            const lateModal = document.getElementById('lateModal');
            const leaveModal = document.getElementById('leaveModal');

            const rsoSymptom = document.getElementById('rsoSymptom');
            const rsoLocation = document.getElementById('rsoLocation');
            const rsiSymptom = document.getElementById('rsiSymptom');
            const lateReason = document.getElementById('lateReason');
            const lateTime = document.getElementById('lateTime');
            const leaveType = document.getElementById('leaveType');

            const submitRsoBtn = document.getElementById('submitRsoBtn');
            const submitRsiBtn = document.getElementById('submitRsiBtn');
            const submitLateBtn = document.getElementById('submitLateBtn');
            const submitLeaveBtn = document.getElementById('submitLeaveBtn');
            
            // Modal close buttons
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.onclick = function() {
                    this.parentElement.parentElement.style.display = 'none';
                }
            });
            
            // Outside click to close modals
            window.onclick = function(event) {
                if (event.target.classList.contains('modal') && event.target.style.display !== 'none') {
                    event.target.style.display = 'none';
                }
            };
            
            // Present Button
            if (presentBtn) {
                presentBtn.addEventListener('click', () => checkLocationAndMarkPresent(OFFICE_LAT, OFFICE_LNG, RADIUS));
            }
            
            // RSO Button
            if (rsoBtn) {
                rsoBtn.addEventListener('click', () => {
                    rsoModal.style.display = 'block';
                    rsoSymptom.value = '';
                    rsoLocation.value = '';
                });
            }
            
            // RSI Button
            if (rsiBtn) {
                rsiBtn.addEventListener('click', () => {
                    rsiModal.style.display = 'block';
                    rsiSymptom.value = '';
                });
            }
            
            // Late Button
            if (lateBtn) {
                lateBtn.addEventListener('click', () => {
                    lateModal.style.display = 'block';
                    lateReason.value = '';
                    lateTime.value = '';
                });
            }
            
            // Leave Button
            if (leaveBtn) {
                leaveBtn.addEventListener('click', () => {
                    leaveModal.style.display = 'block';
                    leaveType.value = 'FullDay';
                });
            }
            
            // Submit buttons
            if (submitRsoBtn) {
                submitRsoBtn.addEventListener('click', () => {
                    const symptom = rsoSymptom.value.trim();
                    const location = rsoLocation.value.trim();
                    
                    if (!symptom || !location) {
                        alert('Please fill in all fields');
                        return;
                    }
                    
                    submitAttendance('RSO', { symptom, location });
                    rsoModal.style.display = 'none';
                });
            }
            
            if (submitRsiBtn) {
                submitRsiBtn.addEventListener('click', () => {
                    const symptom = rsiSymptom.value.trim();
                    
                    if (!symptom) {
                        alert('Please enter symptom');
                        return;
                    }
                    
                    submitAttendance('RSI', { symptom });
                    rsiModal.style.display = 'none';
                });
            }
            
            if (submitLateBtn) {
                submitLateBtn.addEventListener('click', () => {
                    const reason = lateReason.value.trim();
                    const time = lateTime.value;
                    
                    if (!reason || !time) {
                        alert('Please fill in all fields');
                        return;
                    }
                    
                    submitAttendance('Late', { reason, time });
                    lateModal.style.display = 'none';
                });
            }
            
            if (submitLeaveBtn) {
                submitLeaveBtn.addEventListener('click', () => {
                    const type = leaveType.value;
                    submitAttendance('Leave', { type });
                    leaveModal.style.display = 'none';
                });
            }
            
            console.log("‚úì Attendance module initialized");
        }

        // ============================================
        // LOCATION CHECKING
        // ============================================
        function checkLocationAndMarkPresent(OFFICE_LAT, OFFICE_LNG, RADIUS) {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            
            const presentBtn = document.getElementById('presentBtn');
            presentBtn.disabled = true;
            presentBtn.textContent = 'Checking location...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    const distance = calculateDistance(userLat, userLng, OFFICE_LAT, OFFICE_LNG);
                    
                    presentBtn.disabled = false;
                    presentBtn.textContent = 'Present';
                    
                    if (distance <= RADIUS) {
                        submitAttendance('Present', {});
                    } else {
                        alert(`‚ùå You are ${Math.round(distance)}m away from the office.\nYou must be within ${RADIUS}m to mark present.`);
                    }
                },
                (error) => {
                    const presentBtn = document.getElementById('presentBtn');
                    presentBtn.disabled = false;
                    presentBtn.textContent = 'Present';
                    
                    console.error('Geolocation error:', error);
                    let errorMsg = 'Unable to get your location.\n';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Please enable location services.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Location request timed out.';
                            break;
                        default:
                            errorMsg += 'An unknown error occurred.';
                    }
                    
                    alert(errorMsg);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        // ============================================
        // CALCULATE DISTANCE
        // ============================================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }

        // ============================================
        // SUBMIT ATTENDANCE
        // ============================================
        function submitAttendance(type, data) {
            if (!currentUser) {
                alert('You must be logged in to submit attendance');
                return;
            }
            
            const attendanceData = {
                userId: currentUser.uid,
                userName: currentUser.displayName || 
                         (currentUser.email ? currentUser.email.split('@')[0] : 'Unknown'),
                userEmail: currentUser.email || '',
                type: type,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                ...data
            };
            
            db.collection('attendance').add(attendanceData)
                .then(() => {
                    alert(`‚úÖ ${type} attendance submitted successfully!`);
                    console.log("‚úì Attendance submitted:", type);
                })
                .catch((error) => {
                    console.error('‚úó Error submitting attendance:', error);
                    alert('Failed to submit attendance: ' + error.message + '\n\nPlease check:\n1. Disable ad blockers\n2. Check internet connection');
                });
        }

        // ============================================
        // ADMIN DASHBOARD
        // ============================================
        function loadAdminDashboard() {
            if (!isAdmin) return;
            
            console.log("‚Üí Loading admin dashboard");
            
            const totalUsers = document.getElementById('totalUsers');
            const todaysAttendance = document.getElementById('todaysAttendance');
            const pendingMcs = document.getElementById('pendingMcs');
            const adminTableContainer = document.getElementById('adminTableContainer');
            
            db.collection('users').get()
                .then((snapshot) => {
                    totalUsers.textContent = snapshot.size;
                })
                .catch((error) => {
                    console.error('Error getting users:', error);
                });
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            db.collection('attendance')
                .where('timestamp', '>=', today)
                .get()
                .then((snapshot) => {
                    todaysAttendance.textContent = snapshot.size;
                })
                .catch((error) => {
                    console.error('Error getting attendance:', error);
                });
            
            pendingMcs.textContent = '0';
            
            db.collection('attendance')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get()
                .then((snapshot) => {
                    if (snapshot.empty) {
                        adminTableContainer.innerHTML = '<p>No attendance records found</p>';
                        return;
                    }
                    
                    let tableHTML = `
                        <table style="
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                            background: white;
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        ">
                            <thead>
                                <tr>
                                    <th style="
                                        padding: 12px;
                                        text-align: left;
                                        border-bottom: 1px solid #ddd;
                                        background-color: #667eea;
                                        color: white;
                                        font-weight: bold;
                                    ">Name</th>
                                    <th style="
                                        padding: 12px;
                                        text-align: left;
                                        border-bottom: 1px solid #ddd;
                                        background-color: #667eea;
                                        color: white;
                                        font-weight: bold;
                                    ">Type</th>
                                    <th style="
                                        padding: 12px;
                                        text-align: left;
                                        border-bottom: 1px solid #ddd;
                                        background-color: #667eea;
                                        color: white;
                                        font-weight: bold;
                                    ">Date</th>
                                    <th style="
                                        padding: 12px;
                                        text-align: left;
                                        border-bottom: 1px solid #ddd;
                                        background-color: #667eea;
                                        color: white;
                                        font-weight: bold;
                                    ">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const date = data.timestamp ? data.timestamp.toDate().toLocaleString() : 'N/A';
                        
                        let details = '';
                        if (data.symptom) details += `Symptom: ${data.symptom}<br>`;
                        if (data.location) details += `Location: ${data.location}<br>`;
                        if (data.reason) details += `Reason: ${data.reason}<br>`;
                        if (data.time) details += `Time: ${data.time}<br>`;
                        if (data.type) details += `Leave Type: ${data.type}<br>`;
                        
                        tableHTML += `
                            <tr onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor=''">
                                <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${data.userName || 'N/A'}</td>
                                <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${data.type}</td>
                                <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${date}</td>
                                <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${details || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += `
                            </tbody>
                        </table>
                    `;
                    
                    adminTableContainer.innerHTML = tableHTML;
                })
                .catch((error) => {
                    console.error('Error loading attendance table:', error);
                    adminTableContainer.innerHTML = '<p>Error loading data</p>';
                });
        }

        // ============================================
        // DEBUG INFO
        // ============================================
        console.log("=== APP DEBUG INFO ===");
        console.log("Firebase:", typeof firebase !== 'undefined' ? "‚úì Loaded" : "‚úó NOT LOADED");
        console.log("Auth:", typeof auth !== 'undefined' ? "‚úì Initialized" : "‚úó NOT INITIALIZED");
        console.log("Firestore:", typeof db !== 'undefined' ? "‚úì Initialized" : "‚úó NOT INITIALIZED");
        console.log("======================");
        
        // ============================================
        // AD BLOCKER WARNING
        // ============================================
        setTimeout(() => {
            console.log("\n‚ö†Ô∏è  IMPORTANT: If registration fails, check:");
            console.log("1. Disable ad blockers/privacy extensions");
            console.log("2. Check browser console for 'ERR_BLOCKED_BY_CLIENT'");
            console.log("3. Make sure Firestore rules allow writes\n");
        }, 2000);
    </script>
</body>
</html>
